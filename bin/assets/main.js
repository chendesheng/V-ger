
function tasks_ctrl ($scope, $http) {
	// $scope.tasks = [{"URL":"http://vod0.t17.lixian.vip.xunlei.com:443/download?fid=zLD06JdslkRC1vGPmgaXSehdmEOCw8VVAAAAABPQvWu/lExZ9xJus2dIHT/dub1F&mid=666&threshold=150&tid=AD52ABE8F02BE108BC30BF2158D7A6CD&srcid=4&verno=1&g=13D0BD6BBF944C59F7126EB367481D3FDDB9BD45&scn=t9&i=D2CCFADAD009C00E25A8F743BEECA98CF79BC220&t=6&ui=119888259&ti=140221248894&s=1439024002&m=0&n=013241852D74616375121FB76F334530354F06D66F702E48443567CA273236342D2467AB1356452E6D0A47E45F00000000&ih=D2CCFADAD009C00E25A8F743BEECA98CF79BC220&fi=0&pi=140221248574&ff=0&co=2A182BC628935EFB468E315F134FDEC1&cm=1&ts=1362227678","Size":1439024002,"Name":"Spartacus.S03E05.720p.HDTV.x264-EVOLVE.mkv","StartDate":"2013-03-02 20:34:39.730873 +0800 CST","DownloadedSize":879001600,"ElapsedTime":3280000000000,"LimitSpeed":0,"Speed":232.0399114448683,"Status":"Stopped","NameHash":"U3BhcnRhY3VzLlMwM0UwNS43MjBwLkhEVFYueDI2NC1FVk9MVkUubWt2"},{"URL":"http://vod13.t13.lixian.vip.xunlei.com:443/download?fid=qsW0Df/ffmTp0jlGdRSTy0/C/CMkRDBCAAAAAKVchJdhtTu0j4rQTSJvYZGZqono&mid=666&threshold=150&tid=A745DF5645AF315E342F866C4176D52B&srcid=4&verno=1&g=A55C849761B53BB48F8AD04D226F619199AA89E8&scn=t10&i=C0C9219DC2ABB95D2FE08899A6502373EE0AD1A2&t=6&ui=119888259&ti=139846398590&s=1110459428&m=0&n=015103D56D2D6162735008D07161766900&ih=C0C9219DC2ABB95D2FE08899A6502373EE0AD1A2&fi=0&pi=139846398270&ff=0&co=D6F1979486BFB3896C408D1D2641F4B5&cm=1&ts=1362164032","Size":1110459428,"Name":"0212-abs194.avi","StartDate":"2013-03-02 02:53:54.42146 +0800 CST","DownloadedSize":42188800,"ElapsedTime":500000000000,"LimitSpeed":0,"Speed":175.99635335555848,"Status":"Stopped","NameHash":"MDIxMi1hYnMxOTQuYXZp"},{"URL":"http://vod24.t19.lixian.vip.xunlei.com/download?fid=4TsAV9wryK3b6SmXTkBrfMzSNqveHX0xAAAAAOVeofCP5/l+VlboIuKTUMgZhkkB&mid=666&threshold=150&tid=812DEF46240BF5751B779F538BD216B9&srcid=4&verno=1&g=E55EA1F08FE7F97E5656E822E29350C819864901&scn=t8&i=A78FC489C78B037196A6FCC9F79621F2E31F147C&t=6&ui=119888259&ti=139601002878&s=830283230&m=0&n=013B5496302E486F75131FB10C2E5330312401D671373230704F79A00B562E58325705C91B494D454E3278AB112E6D6B76&ih=A78FC489C78B037196A6FCC9F79621F2E31F147C&fi=0&pi=139601002558&ff=0&co=FBD3CCEB154F81E0786C6AF669EFF916&cm=1&ts=1362136506","Size":830283230,"Name":"Zero.Hour.US.S01E02.720p.HDTV.X264-DIMENSION.mkv","StartDate":"2013-03-01 19:15:06.755767 +0800 CST","DownloadedSize":830283230,"ElapsedTime":3240000000000,"LimitSpeed":0,"Speed":250.20197756414655,"Status":"Finished","NameHash":"WmVyby5Ib3VyLlVTLlMwMUUwMi43MjBwLkhEVFYuWDI2NC1ESU1FTlNJT04ubWt2"},{"URL":"http://vod6.t19.lixian.vip.xunlei.com:443/download?fid=4w71nk3AVY8BgGM4yVs10gW1iXXu21swAAAAAHGg6xKNNaQXi8rn8ABltGg1vcBB&mid=666&threshold=150&tid=CA70948CE15F1496B96F684DAE516EA0&srcid=4&verno=1&g=71A0EB128D35A4178BCAE7F00065B46835BDC041&scn=t17&i=92314B4B54B688AD13CF203BA828AC21&t=4&ui=119888259&ti=139169843774&s=811326446&m=0&n=01205C812D6963616E121FD66F31332E535100A16F352E37325141CA174454562E3903D26B2D44494D247FB7164F4E2E6D0A47E45F00000000&ff=0&co=E6BB579B0F86B3CBE5CDF12842D21F7C&cm=1&ts=1362061033","Size":811326446,"Name":"Americans.2013.S01E05.720p.HDTV.X264-DIMENSION.mkv","StartDate":"2013-02-28 22:17:21.007525 +0800 CST","DownloadedSize":811326446,"ElapsedTime":7350000000000,"LimitSpeed":0,"Speed":190.604909957619,"Status":"Finished","NameHash":"QW1lcmljYW5zLjIwMTMuUzAxRTA1LjcyMHAuSERUVi5YMjY0LURJTUVOU0lPTi5ta3Y"},{"URL":"http://ftp-idc.pconline.com.cn/7bbb0733b8a390d582efc299f1c06483/pub/download/201010/jdk-7u1-windows-7.0.zip","Size":82736058,"Name":"jdk-7u1-windows-7.0.zip","StartDate":"2013-02-28 00:34:23.538199 +0800 CST","DownloadedSize":14489600,"ElapsedTime":2246000000000,"LimitSpeed":50,"Speed":178.6736538506334,"Status":"Stopped","NameHash":"amRrLTd1MS13aW5kb3dzLTcuMC56aXA"},{"URL":"http://c758482.r82.cf2.rackcdn.com/Sublime%20Text%20Build%203012.dmg","Size":8950745,"Name":"Sublime Text Build 3012.dmg","StartDate":"2013-02-27 23:27:56.767916 +0800 CST","DownloadedSize":8950745,"ElapsedTime":236000000000,"LimitSpeed":0,"Speed":49.99360706749624,"Status":"Finished","NameHash":"U3VibGltZSBUZXh0IEJ1aWxkIDMwMTIuZG1n"},{"URL":"http://vod57.t16.lixian.vip.xunlei.com:443/download?fid=+LyMXzaFZWOVU7yqTtImKdYLJuzcctA4AAAAAIc+lZWLf6zFylH4rOFMio3psInY&mid=666&threshold=150&tid=FAB859323F0EC480B6048012A3B4ADC7&srcid=4&verno=1&g=873E95958B7FACC5CA51F8ACE14C8A8DE9B089D8&scn=t6&i=8D936C1F08D3BE839BE0134DADA7C003&t=4&ui=119888259&ti=138482173758&s=953184988&m=0&n=012244882B2E5330312401D671373230704F79A00B562E58325705C91B494D454E3278AB112E6D6B76&ff=0&co=25C0ECA30FC42C1BB7A387C8A343EDC2&cm=1&ts=1361954176","Size":953184988,"Name":"Cult.S01E02.720p.HDTV.X264-DIMENSION.mkv","StartDate":"2013-02-27 16:36:07.8433264 +0800 CST","DownloadedSize":953184988,"ElapsedTime":9656000000000,"LimitSpeed":0,"Speed":185.9089690670714,"Status":"Finished","NameHash":"Q3VsdC5TMDFFMDIuNzIwcC5IRFRWLlgyNjQtRElNRU5TSU9OLm1rdg"},{"URL":"http://vod66.t16.lixian.vip.xunlei.com:443/download?fid=y+I0VVAmSAcYCDcRXO0FSHFXDE+PImspAAAAANePhIRq9JXjq2WruNABXGKILx2k&mid=666&threshold=150&tid=301F03B4331D12B2DABB4D3299998DD7&srcid=4&verno=1&g=D78F84846AF495E3AB65ABB8D0015C62882F1DA4&scn=t16&i=345C56760F915B10F10B79532B86E61E&t=4&ui=119888259&ti=137558767934&s=694887055&m=0&n=0126589633732E53305374D4682E373230111FAC1B54562E785307D07245564F4C3774CA326B760000&ff=0&co=7FA0CE776E96024F67FAC955DA7D6EB1&cm=1&ts=1361903402","Size":694887055,"Name":"Girls.S02E07.720p.HDTV.x264-EVOLVE.mkv","StartDate":"2013-02-27 02:30:02.847224 +0800 CST","DownloadedSize":137994240,"ElapsedTime":1500000000000,"LimitSpeed":0,"Speed":0,"Status":"Downloading","NameHash":"R2lybHMuUzAyRTA3LjcyMHAuSERUVi54MjY0LUVWT0xWRS5ta3Y"}];
	function get_process() {
		$http.get('/progress').success(function(data) {
			for (var i = data.length - 1; i >= 0; i--) {
				var item = data[i];
				item.StartDate = new Date(Date.parse(item.StartDate))
			};

			var collection  =  {};
			for (var i = data.length - 1; i >= 0; i--) {
				var item = data[i]
				collection[item.Name] = item;
			};
			var tasks = $scope.tasks;
			for (var i = tasks.length - 1; i >= 0; i--) {
				var task = tasks[i];
				var source = collection[task.Name];
				if (source) {
					angular.forEach(source, function (val, key) {
						task[key] = val;
					});
					delete collection[task.Name];
				} else {
					tasks.splice(i, 1);
				}
			}
			angular.forEach(collection, function (val, key) {
				tasks.push(val)
			});
		})
	}
	function init() {
		$http.get('/progress').success(function(data) {
			for (var i = data.length - 1; i >= 0; i--) {
				var item = data[i];
				item.StartDate = new Date(Date.parse(item.StartDate))
			};
			$scope.tasks = data;
		})
	}

	init();
	setInterval(get_process, 2000)

	$scope.parse_duration = function(dur) {
		var sec = Math.floor(dur/1000000000);
		var min = Math.floor(sec/60);
		var hour = Math.floor(min/60);
		var day = Math.floor(hour/24);

		return (day>0?day+'d':'')+(hour>0?hour%24+'h':'')+(min>0?min%60+'m':'')+(sec>0?sec%60+'s':'');
	}

	$scope.send_open = function (task) {
		$http.get('/play/' + task.Name).success(function (resp) {
			resp && alert(resp);
		});
	}
	$scope.send_resume = function (task) {
		$http.get('/resume/' + task.Name).success(function (resp) {
			resp && alert(resp);
		});
	}
	$scope.send_stop = function (task) {
		$http.get('/stop/' + task.Name).success(function (resp) {
			resp && alert(resp);
		});
	}
	$scope.send_limit = function (task) {
		$http.post('/limit/' + task.Name, task.LimitSpeed).success(function (resp) {
			resp && alert(resp);
		});
	};

	$scope.waiting = false;
	$scope.new_task = function() {
		$scope.waiting = true;
		if ($scope.new_url.indexOf('lixian.vip.xunlei.com') != -1) {
			$http.post('/new', $scope.new_url).success(function(resp) {
				$scope.new_url = '';
				$scope.waiting = false;
				resp && alert(resp);
			}).error(function(){$scope.waiting = false;});
		} else {
			$http.post('/thunder/new', $scope.new_url).success(function(data) {
				for (var i = data.length - 1; i >= 0; i--) {
					var item = data[i];
					item.loading = false;
				};
				$scope.bt_files = data;
			});
		}
	};
	// $scope.thunder_new = function() {
	// 	// $scope.bt_files = [
	// 	// 	{Status:'Finished', Name:'Catch me if you can.', Size:'1.5GB', URL:'http://www.xyz.com'}
	// 	// ];
	// };
	$scope.get_bt_file_status = function(percent) {
		return (percent == 100) ? 'Finished' : percent + '%'
	}

	$scope.download_bt_files = function(file) {
		file.loading = true;
		$http.post('/new', file.DownloadURL).success(function(resp) {
			file.loading = false;
			if (resp) alert(resp);
			else {
				$scope.bt_files = [];
				$scope.new_url = '';
				$scope.waiting = false;
			}
		}).error(function() {
			file.loading = false;
			$scope.waiting = false;
		});
	};
	$scope.bt_files = [];


	//subtitles
	$scope.subtitles = [];
	$scope.subtitles_movie_name = '';

	$scope.search_subtitles = function(task) {
		$scope.subtitles_movie_name = task.Name;
		$http.get('/subtitles/search/' + task.Name).success(function (data) {
			if (data.length == 0) {
				alert("Can't find subtitles!");
				return
			}
			for (var i = data.length - 1; i >= 0; i--) {
				var item = data[i];
				item.loading = false;

				//truncate description
				var description = item.Description;
				if (description.length > 50)
					item.Description = description.substr(0, 50) + '...';

			};
			$scope.subtitles = data;
		});
	}
	$scope.download_subtitles = function (sub) {
		sub.loading = true;
		$http.post('/subtitles/download/'+$scope.subtitles_movie_name, sub.URL).success(function () {
			sub.loading = false;
			$scope.subtitles = [];
		})
	}

	function notify_task_done(name) {
		var myNotification = new Notify('V\'ger Task Finished', {
		    body: name,
		    tag: name+'done',
		});
		myNotification.show();
	}
}
