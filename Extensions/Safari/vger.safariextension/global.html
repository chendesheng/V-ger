<!--
Global HTML Page to control the extension logic.
-->
<!DOCTYPE HTML>

<script>
// Set up the Listener
// safari.application.addEventListener("contextmenu", handleContextMenu, false);
// function handleContextMenu(event) {
    
// }
// Function to perform when event is received

safari.application.addEventListener("command", performCommand, false);
function performCommand(event) {
	// Make sure event comes from the button
	if (event.command == "download") {
		console.log(currentLinkURL);

		if (currentLinkURL.indexOf('lixian.vip.xunlei.com') != -1 ||
			currentLinkURL.indexOf('youtube.com') != -1 || 
			/.*dmg|.*zip|.*rar|.*exe$/.test(currentLinkURL)) {
			post('/new/', currentLinkURL);
		} else {
			var data = JSON.stringify({
				"url": currentLinkURL,
				"verifycode": ""
			});
			post('/thunder/new', data, function (data) {
				for (var i = 0; i < data.length; i++) {
					var f = data[i];
					if (f.Percent == 100 && /\.(mkv|avi|mp4|rmvb|rm|wmv)$/i.test(f.Name)) {
						downloadFile(f);
						return;
					}
				}

				alert(currentPage, 'Download fail.');
			});
		}
	} else if (event.command == "play") {
		var data = JSON.stringify({
			"url": currentLinkURL,
			"verifycode": ""
		});
		post('/thunder/new', data, function (data) {
			for (var i = 0; i < data.length; i++) {
				var f = data[i];
				if (f.Percent == 100 && /\.(mkv|avi|mp4|rmvb|rm|wmv)$/i.test(f.Name)) {
					post('/new/' + encodeURIComponent(f.Name), f.DownloadURL, function() {
						post('/play/' + encodeURIComponent(f.Name));
					});
					return;
				}
			}

			alert(currentPage, 'Download fail.');
		});
	}
}


function alert(page, m) {
	if (currentPage != null) {
		page.dispatchMessage("alert", m);
	}
}
function downloadFile(f) {
	post('/new/' + encodeURIComponent(f.Name), f.DownloadURL, function(resp) {});
}

var currentLinkURL = "";
var currentPage = null;

safari.application.addEventListener("message", handleMessage, false);
function handleMessage (event) {
	if (event.name == "contextmenu") {
		currentLinkURL = event.message;
		currentPage = event.target.page;
	}
}


var baseUrl = safari.extension.settings.server;//'http://localhost:9527';
console.log(baseUrl);

function post(path, data, success) {
	console.log('post ' + path + ' ' + data);
	var request = new XMLHttpRequest();
	request.open("POST", baseUrl + path);
	request.send(data);
	request.onreadystatechange = function()
	{
	    // "4" means "completed"
	    if (request.readyState != 4) return;

	    console.log(request.responseText);
	    if (success) {
	    	if (!request.responseText) {
	    		success("");
	    	} else {
		    	success(JSON.parse(request.responseText));
	    	}
	    }
	};
}

</script>